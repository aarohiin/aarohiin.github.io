import streamlit as st
import json
import os
from PIL import Image
import uuid

# Constants
DATA_FILE = "data.json"
MEDIA_FOLDER = "media"

# Ensure media folder exists
os.makedirs(MEDIA_FOLDER, exist_ok=True)

# Initialize data structure
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r") as f:
            return json.load(f)
    else:
        return {section: [] for section in [
            "education", "certification", "skills",
            "achievements", "experience", "projects"
        ]}

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f, indent=2)

# Load existing data
data = load_data()

st.title("ðŸ“Œ Portfolio Entry Manager")

# Section dropdown
section = st.selectbox("Select Section", list(data.keys()))

# Input fields
title = st.text_input("Title")
description = st.text_area("Description")

# Optional media
st.markdown("### Upload Media (Optional)")
uploaded_images = st.file_uploader("Images", type=["png", "jpg", "jpeg"], accept_multiple_files=True)
uploaded_videos = st.file_uploader("Videos", type=["mp4", "mov", "avi"], accept_multiple_files=True)

# Optional links
st.markdown("### Add Links (Optional)")
raw_links = st.text_area("Enter links (one per line)")
links = [l.strip() for l in raw_links.splitlines() if l.strip()]

# Submit button
if st.button("Add Entry"):
    new_entry = {
        "title": title,
        "description": description,
    }

    media = {}
    if uploaded_images:
        media["images"] = []
        for img in uploaded_images:
            filename = f"{uuid.uuid4().hex}_{img.name}"
            filepath = os.path.join(MEDIA_FOLDER, filename)
            with open(filepath, "wb") as f:
                f.write(img.getbuffer())
            media["images"].append(filepath)
    
    if uploaded_videos:
        media["videos"] = []
        for vid in uploaded_videos:
            filename = f"{uuid.uuid4().hex}_{vid.name}"
            filepath = os.path.join(MEDIA_FOLDER, filename)
            with open(filepath, "wb") as f:
                f.write(vid.getbuffer())
            media["videos"].append(filepath)

    if media:
        new_entry["media"] = media

    if links:
        new_entry["links"] = links

    # Append to selected section
    data[section].append(new_entry)
    save_data(data)

    st.success(f"âœ… Entry added to '{section}' successfully!")

# Debugging/Display
if st.checkbox("Show Current Data"):
    st.json(data)
